document.addEventListener("DOMContentLoaded", () => {
  const toggleBtn = document.getElementById("toggle-genres");
  const categoryList = document.getElementById("category-list");
  const inputBusca = document.getElementById("busca");
  const containerCards = document.getElementById("card_buys-container");
  const jogos = [
    {
      index: 0,
      nome: "The Witcher 3: Wild Hunt",
      ano: 2015,
      preco: 59.99,
      descricao: "Um RPG de mundo aberto aclamado pela crítica, cheio de missões e decisões que importam.",
      dev: "CD Projekt Red",
      categoria: "RPG",
      imagens: [
        "/img/the-witcher-3.jpg",
        "/img/the-witcher-3-1.jpg",
        "/img/the-witcher-3-2.jpg",
        "/img/the-witcher-3-3.jpg"
      ],
      avaliacoes: [
        "Um dos mundos mais vivos e bem construídos dos games.",
        "História envolvente e personagens memoráveis.",
        "Cada missão é uma pequena obra-prima narrativa."
      ]
    },
    {
      index: 1,
      nome: "Red Dead Redemption 2",
      ano: 2018,
      preco: 59.99,
      descricao: "Um épico de faroeste imersivo da Rockstar, com uma história intensa e mundo aberto vibrante.",
      dev: "Rockstar Games",
      categoria: "Ação",
      imagens: [
        "/img/red-dead2.jpg",
        "/img/red-dead2-1.jpg",
        "/img/red-dead2-2.jpg",
        "/img/red-dead2-3.jpg"
      ],
      avaliacoes: [
        "Ambientação e narrativa no mais alto nível.",
        "Um dos jogos mais detalhados já feitos.",
        "Impossível não se envolver com o elenco e o mundo."
      ]
    },
    {
      index: 2,
      nome: "The Legend of Zelda: Breath of the Wild",
      ano: 2017,
      preco: 59.99,
      descricao: "Aventura de mundo aberto com liberdade total para explorar o reino de Hyrule.",
      dev: "Nintendo",
      categoria: "Aventura",
      imagens: [
        "/img/zelda.jpg",
        "/img/zelda-1.jpg",
        "/img/zelda-2.jpg",
        "/img/zelda-3.jpg"
      ],
      avaliacoes: [
        "Exploração que realmente recompensa a curiosidade.",
        "Visual e trilha sonora inesquecíveis.",
        "Reinvenção brilhante da fórmula Zelda."
      ]
    }
  ];

  const categoriasUnicas = ["Todos", ...new Set(jogos.map(j => j.categoria))];

  const iconesPorCategoria = {
    "Ação": "fa-gun",
    "RPG": "fa-hat-wizard",
    "Aventura": "fa-mountain-sun",
    "Estratégia": "fa-chess-board",
    "Terror": "fa-ghost",
    "Indie": "fa-puzzle-piece",
    "FPS": "fa-bullseye",
    "Exploração": "fa-compass",
    "Futurista": "fa-robot",
    "Mundo Aberto": "fa-earth-americas",
    "Desafio": "fa-fire"
  };

  const listaCategorias = document.getElementById("category-list");
  listaCategorias.innerHTML = "";

  categoriasUnicas.forEach(cat => {
    const li = document.createElement("li");
    li.classList.add("cardc");
    const iconClass = iconesPorCategoria[cat] || "fa-gamepad";
    li.innerHTML = `<i class="fa-solid ${iconClass}"></i> ${cat}`;

    li.addEventListener("click", () => {
      document.querySelectorAll(".cardc").forEach(c => c.classList.remove("selected"));
      li.classList.add("selected");
      categoriaSelecionada = cat;
      aplicarFiltros();
    });

    listaCategorias.appendChild(li);
  });

  function criarCard(jogo, index) {
    const card = document.createElement("div");
    card.className = "card_buy";

    const img = document.createElement("img");
    img.src = (jogo.imagens && jogo.imagens.length > 0)
      ? jogo.imagens[0]
      : "/img/placeholder.jpg";
    img.alt = jogo.nome;
    img.onerror = () => {
      img.src = "/img/placeholder.jpg";
    };

    const rating = document.createElement("div");
    rating.className = "card-rating";
    rating.innerHTML = `<i class="fa-solid fa-star"></i> ${jogo.avaliacao ?? (Math.random() * 2 + 3).toFixed(1)}`;

    const addFav = document.createElement("div");
    addFav.className = "add-wishlist";
    addFav.innerHTML = `<i class="fa-solid fa-plus"></i>`;
    addFav.title = "Adicionar à lista de desejos";
    addFav.onclick = (event) => {
      event.stopPropagation();
      adicionarFavorito(jogo);
    };

    const info = document.createElement("div");
    info.className = "card-info";
    const titulo = document.createElement("h3");
    titulo.textContent = jogo.nome;
    const descricao = document.createElement("p");
    descricao.textContent = jogo.descricao;
    const preco = document.createElement("span");
    preco.className = "price";
    preco.textContent = `R$ ${jogo.preco.toFixed(2)}`;
    const buy = document.createElement("button");
    buy.className = "buy-btn";
    buy.textContent = "Comprar";
    buy.onclick = (event) => {
      event.stopPropagation();
      adicionarAoCarrinho(jogo.nome, jogo.preco);
    };
    info.append(titulo, descricao, preco, buy);

    const top = document.createElement("div");
    top.className = "card-top";
    top.append(rating, addFav);

    card.append(img, top, info);
    card.addEventListener("click", () => {
      window.location.href = `descricao.html?index=${jogo.index}`;
    });
    return card;
  }

  function renderizarJogos(lista) {
    containerCards.innerHTML = "";
    lista.forEach((jogo, index) => {
      const card = criarCard(jogo, index);
      containerCards.appendChild(card);
    });
  }

  function adicionarAoCarrinho(nome, preco) {
    const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
    carrinho.push({ nome, preco });
    localStorage.setItem("carrinho", JSON.stringify(carrinho));
    alert("Adicionado ao carrinho!");
  }

  function adicionarFavorito(jogo) {
    const loggedUser = JSON.parse(localStorage.getItem("loggedUser"));
    if (!loggedUser) {
      alert("Você precisa estar logado para favoritar jogos.");
      return;
    }

    const email = loggedUser.email;
    const allFavorites = JSON.parse(localStorage.getItem("wishlistPorUsuario")) || {};
    const userFavorites = allFavorites[email] || [];

    const index = userFavorites.findIndex(j => j.nome === jogo.nome);
    if (index === -1) {
      userFavorites.push({ nome: jogo.nome, preco: jogo.preco, index: jogo.index });
    } else {
      userFavorites.splice(index, 1);
    }

    allFavorites[email] = userFavorites;
    localStorage.setItem("wishlistPorUsuario", JSON.stringify(allFavorites));

    alert(`${jogo.nome} foi ${index === -1 ? "adicionado à" : "removido da"} wishlist.`);
  }

  function filtrarPorCategoria(categoria) {
    if (categoria === "Todos") return jogos;
    return jogos.filter(j => j.categoria === categoria);
  }

  function filtrarPorTexto(texto) {
    const termo = texto.toLowerCase();
    return jogos.filter(jogo => jogo.nome.toLowerCase().includes(termo));
  }

  let categoriaSelecionada = "Todos";

  function aplicarFiltros() {
    let filtrados = jogos;
    if (categoriaSelecionada !== "Todos") {
      filtrados = filtrados.filter(j => j.categoria.includes(categoriaSelecionada));
    }
    const textoBusca = inputBusca.value.trim().toLowerCase();
    if (textoBusca) {
      filtrados = filtrados.filter(j => j.nome.toLowerCase().includes(textoBusca));
    }
    renderizarJogos(filtrados);
  }

  toggleBtn.addEventListener("click", () => {
    categoryList.classList.toggle("visible");
  });

  categoryList.addEventListener("click", (e) => {
    if (e.target.classList.contains("cardc")) {
      categoriaSelecionada = e.target.textContent.trim();
      document.querySelectorAll(".cardc").forEach(el => el.classList.remove("selected"));
      e.target.classList.add("selected");
      aplicarFiltros();
    }
  });

  inputBusca?.addEventListener("input", () => {
    aplicarFiltros();
  });

  renderizarJogos(jogos);
});
