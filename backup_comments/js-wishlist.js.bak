document.addEventListener("DOMContentLoaded", () => {
  const lista = document.getElementById("wishlist-list");
  const contador = document.getElementById("wishlist-count");
  const loggedUser = JSON.parse(localStorage.getItem("loggedUser"));
  const allWishlists = JSON.parse(localStorage.getItem("wishlistPorUsuario")) || {};
  const wishlist = loggedUser ? allWishlists[loggedUser.email] || [] : [];
  const jogos = [
    {
      index: 0,
      nome: "The Witcher 3: Wild Hunt",
      ano: 2015,
      preco: 59.99,
      descricao: "Um RPG de mundo aberto aclamado pela crítica, cheio de missões e decisões que importam.",
      dev: "CD Projekt Red",
      categoria: "RPG",
      imagens: [
        "/img/the-witcher-3.jpg",
        "/img/the-witcher-3-1.jpg",
        "/img/the-witcher-3-2.jpg",
        "/img/the-witcher-3-3.jpg"
      ],
      avaliacoes: [
        "Um dos mundos mais vivos e bem construídos dos games.",
        "História envolvente e personagens memoráveis.",
        "Cada missão é uma pequena obra-prima narrativa."
      ]
    }
  ];

   if (!loggedUser) {
    lista.innerHTML = "<p>Você precisa estar logado para ver sua wishlist.</p>";
    contador.textContent = "";
    return;
  }

  if (wishlist.length === 0) {
    lista.innerHTML = "<p>Você ainda não adicionou jogos à sua lista de desejos.</p>";
    contador.textContent = "Nenhum jogo salvo";
    return;
  }

  contador.textContent = `${wishlist.length} jogo${wishlist.length > 1 ? "s" : ""} salvo${wishlist.length > 1 ? "s" : ""}`;

  wishlist.forEach((item, index) => {
    const jogo =
      jogos.find(j => j.index === item.index || j.nome === item.nome) || item;

    const card = document.createElement("div");
    card.className = "wishlist-card";

    const img = document.createElement("img");
    img.src = jogo.imagens?.[0] || "img/placeholder.jpg";
    img.alt = jogo.nome;

    const removeBtn = document.createElement("button");
    removeBtn.className = "remove-btn";
    removeBtn.innerHTML = `<i class="fa-solid fa-trash"></i>`;
    removeBtn.addEventListener("click", () => {
      if (confirm(`Remover ${jogo.nome} da wishlist?`)) {
        wishlist.splice(index, 1);
        allWishlists[loggedUser.email] = wishlist;
        localStorage.setItem("wishlistPorUsuario", JSON.stringify(allWishlists));
        location.reload();
      }
    });

    const info = document.createElement("div");
    info.className = "wishlist-info";
    info.innerHTML = `
      <h3>${jogo.nome}</h3>
      <p>${jogo.descricao}</p>
      <div class="rating"><i class="fa-solid fa-star"></i> ${jogo.nota || (4 + Math.random()).toFixed(1)}</div>
      <p class="price">R$ ${jogo.preco?.toFixed(2)}</p>
    `;

    const btns = document.createElement("div");
    btns.className = "wishlist-actions";

    const btnCarrinho = document.createElement("button");
    btnCarrinho.className = "btn-cart";
    btnCarrinho.innerHTML = `<i class="fa-solid fa-cart-shopping"></i> Carrinho`;
    btnCarrinho.addEventListener("click", () => {
      const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
      carrinho.push(jogo);
      localStorage.setItem("carrinho", JSON.stringify(carrinho));
      alert(`${jogo.nome} foi adicionado ao carrinho!`);
    });

    const btnComprar = document.createElement("button");
    btnComprar.className = "btn-buy";
    btnComprar.textContent = "Comprar";
    btnComprar.addEventListener("click", () => {
      alert(`Compra iniciada para ${jogo.nome}!`);
    });

    btns.append(btnCarrinho, btnComprar);
    card.append(img, removeBtn, info, btns);
    lista.appendChild(card);
  });
});
